{% extends "base.html" %}

{% block title %}Add New Story - Scrollarr{% endblock %}

{% block content %}
    <header class="mb-8">
        <h1 class="text-3xl font-bold">Add New Story</h1>
    </header>

    <div class="max-w-2xl mx-auto bg-gray-800 rounded-lg p-8 shadow-lg">
        <div class="mb-6">
            <label class="block text-gray-300 text-sm font-bold mb-2" for="url-input">
                Story URL
            </label>
            <div class="flex gap-2">
                <input type="text" id="url-input" placeholder="Enter Story URL (Royal Road, AO3, Questionable Questing)" class="flex-1 p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 transition-colors">
                <button id="search-btn" onclick="lookupStory()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition-colors flex items-center justify-center min-w-[100px]">
                    Search
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Currently supports: Royal Road, Archive of Our Own, Questionable Questing</p>
        </div>

        <div class="mb-6">
            <label class="block text-gray-300 text-sm font-bold mb-2" for="profile-select">
                Ebook Profile
            </label>
            <select id="profile-select" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 transition-colors">
                <!-- Profiles loaded via JS -->
            </select>
            <p class="text-xs text-gray-500 mt-2">Determines the format (EPUB, PDF) and style of the ebook.</p>
        </div>

        <div class="mb-6 hidden" id="qq-options">
             <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="use-all-posts" class="h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 transition duration-150 ease-in-out">
                <span class="text-gray-300 font-medium">Use 'All Posts' Mode (Questionable Questing Only)</span>
            </label>
            <p class="text-xs text-gray-500 mt-1 ml-8">Fetches all posts by the author, treating threadmarks as volume headers. Useful for quests/stories without threadmarked chapters.</p>
        </div>

        <div id="preview-area" class="hidden animate-fade-in">
            <div class="flex items-start gap-6 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                <img id="preview-cover" src="" class="w-24 h-36 object-cover rounded shadow-md">
                <div class="flex-1">
                    <h3 id="preview-title" class="text-xl font-bold text-white mb-1"></h3>
                    <p id="preview-author" class="text-sm text-gray-400 mb-4"></p>
                    <button id="add-btn" onclick="addStory()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add to Library
                    </button>
                </div>
            </div>
        </div>

        <p id="error-msg" class="text-red-400 mt-4 hidden bg-red-900/20 p-3 rounded border border-red-800"></p>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        async function lookupStory() {
            const url = document.getElementById('url-input').value;
            if (!url) return;

            const btn = document.getElementById('search-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>`;

            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('preview-area').classList.add('hidden');

            try {
                const response = await fetch('/api/lookup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url})
                });

                if (!response.ok) throw new Error('Story not found or invalid URL');

                const data = await response.json();

                document.getElementById('preview-title').innerText = data.title;
                document.getElementById('preview-author').innerText = data.author;
                const cover = data.cover_url || 'https://via.placeholder.com/150';
                document.getElementById('preview-cover').src = cover;

                document.getElementById('preview-area').classList.remove('hidden');

            } catch (err) {
                document.getElementById('error-msg').innerText = err.message;
                document.getElementById('error-msg').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function loadProfiles() {
            try {
                const res = await fetch('/api/profiles');
                const profiles = await res.json();
                const select = document.getElementById('profile-select');
                select.innerHTML = '';
                profiles.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = `${p.name} (${p.output_format.toUpperCase()})`;
                    if (p.id === 1) opt.selected = true; // Default to Standard
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("Failed to load profiles", e);
            }
        }

        async function addStory() {
            const url = document.getElementById('url-input').value;
            const profile_id = document.getElementById('profile-select').value;
            const useAllPosts = document.getElementById('use-all-posts') ? document.getElementById('use-all-posts').checked : false;

            let provider_key = null;
            if (useAllPosts && url.includes('questionablequesting.com')) {
                provider_key = 'questionablequesting_all';
            }

            const btn = document.getElementById('add-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg> Adding...`;

            try {
                const payload = {url: url, profile_id: parseInt(profile_id)};
                if (provider_key) {
                    payload.provider_key = provider_key;
                }

                const response = await fetch('/api/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Failed to add story');

                // Redirect to library
                window.location.href = '/';

            } catch (err) {
                document.getElementById('error-msg').innerText = err.message;
                document.getElementById('error-msg').classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Initialize
        loadProfiles();

        document.getElementById('url-input').addEventListener('input', function() {
            const url = this.value;
            const qqOptions = document.getElementById('qq-options');
            if (url.includes('questionablequesting.com')) {
                qqOptions.classList.remove('hidden');
            } else {
                qqOptions.classList.add('hidden');
                document.getElementById('use-all-posts').checked = false;
            }
        });
    </script>
{% endblock %}
